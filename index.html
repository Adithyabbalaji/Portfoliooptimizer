<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
        integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>

    <h1 align="center">PORTFOLIO OPTIMIZER</h1>
    <form>
        <input id="stock" />
        <button id="submit">SUBMIT</button>
    </form>
    <div id="loading" style="display: none;">
        LOADING
    </div>
    <div id="min-risk">

    </div>
    <div id="max-return">

    </div>
    <canvas id="myChart" style="max-height: 500px; max-width: 500px;"></canvas>
    <script>
        let globalChart = undefined;
        const submit = async (e) => {
            if (globalChart != undefined) {
                globalChart.destroy()
                globalChart = undefined
            } 
            document.getElementById("loading").style.display = "block"
            document.getElementById("submit").disabled = true
            
            const minRiskDiv = document.getElementById("min-risk")
            minRiskDiv.innerHTML = "MIN RISK "
            
            const maxReturnDiv = document.getElementById("max-return")
            maxReturnDiv.innerHTML = "MAX RETURN "
            
            e.preventDefault()
            const stock = document.getElementById("stock").value
            const response = await fetch('http://127.0.0.1:5000/api/portfolio?tickers=' + stock, {
                method: 'GET',
            });
            const json = await response.json();
            console.log(json);
            const minRisk = JSON.parse(json.minRisk)
            const maxReturn = JSON.parse(json.maxReturn)
            const df = JSON.parse(json.df)
            for (let [key, value] of Object.entries(minRisk)) {
                console.log(value);
                let k = Object.keys(value)[0];
                let v = value[k];
                minRiskDiv.innerHTML += `${key}: ${v}`

            }
            for (let [key, value] of Object.entries(maxReturn)) {
                let k = Object.keys(value)[0];
                let v = value[k];
                maxReturnDiv.innerHTML += `${key}: ${v}`

            }
            console.log("minRisk", minRisk, "maxReturn", maxReturn, "df", df)
            document.getElementById("submit").disabled = false
            document.getElementById("loading").style.display = "none"
            let colors = ['red', 'green', 'blue', 'yellow', 'purple']
            let xValues = []
            df.index.forEach(e => {
                let date = new Date(e)
                let d = date.getDate() +
                    "/" + (date.getMonth() + 1) +
                    "/" + date.getFullYear()
                xValues.push(d)
            })
            let datasets = []
            df.columns.forEach((e, i) => {
                let data = {
                    data: [],
                    label: e,
                    borderColor: colors[i],
                    fill: false
                }
                datasets.push(data)
            })
            console.log(datasets)
            df.data.forEach(element => {
                element.forEach((e, i) => {
                    datasets[i].data.push(e)
                })
            });

            globalChart = new Chart("myChart", {
                type: "line",
                data: {
                    labels: xValues,
                    datasets: datasets
                },
                options: {
                    legend: { display: false }
                }
            });
        }
        document.getElementById("submit").addEventListener("click", submit)
    </script>
</body>

</html>